你好，我是坤哥



今天和大家分享一下前几天出现的一次使用多线程导致的线上故障，挺有代表性的，这个错误估计比较资深的程序员也会犯错，特此分享出来，相信大家看了肯定收获



### 问题背景

先简单介绍下此次使用多线程改造的业务背景，我们的平台是是返利平台，有一个搜索场景是用户在 app 上输入商品名称，传给 server 后 server 会根据此商品名称来查找其在各个平台（如淘宝，京东，拼多多）上对应的商品列表再返回给 app 进行展示，由于是单线程，显然 server 的处理时间和平台的数量成简单的线性关系（平台越多，server 的处理时间越多），由于各个平台的搜索接口是独立的，所以显然单线程是可以改成多线程的，如下

![](https://files.mdnice.com/user/1650/b3f30174-f7bc-4c48-80b7-cf3a7a6cbd65.png)



改成用多线程后，server 的处理时间只取决于商品搜索接口耗时最长的那一个平台了，显然效率得到了极大的提升，看起来这是一次完美的改造，不过这只是灾难的开始，上线后有大量用户反馈搜索接口不能用，经过定位后发现是因为 app 的版本号（version）无法获取，所以搜索接口会触发引导用户去升级 app 的提示，伪代码如下

```java
static String getAppVersion() {
  String version = getVersion();
  if (StringUtils.isEmpty(version)) {
    	throw new Exception("获取 version 失败，请升级");
  }
  return version;
}
```

好了，原因找到了，那么问题来了，好好的 version 怎么突然间就找不到了呢，我们可以先思考一下这个 version 应该存在哪里比较合适



### threadlocal 简介





主要是为了提高性能将单线程改成多线程